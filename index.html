<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>鼠巴拉西｜第一屆打地鼠大戰</title>
    <link rel="icon" href="img/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="reset.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="preload" href="img/boss.png" as="image">


    <!-- Rubik字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap"
        rel="stylesheet">
</head>

<body>
    <p class="version">測試版本1.0.1</p>
    <div class="hamster_game_box">
        <button id="leaderboard-button">排行榜</button>
        <div id="mask_bg"></div>
        <div id="leaderboard">
            <h2>排行榜</h2>
            <ul id="leaderboard-list"></ul>
            <button id="close-leaderboard">關閉</button>
        </div>

        <div class="text_box_outer">
            <p class="text_box">時間剩餘：<span id="timer">60</span> 秒</p>
            <p class="text_box">分數：<span id="score">0</span></p>
        </div>

        <img src="img/Title04.png" alt="打地鼠遊戲" class="title">

        <div class="game_area">
            <div class="game_rules">
                <li>
                    <img src="img/chuchi.png" alt="惡魔">
                    <p>打擊惡魔鼠鼠<span data-stroke="獲得10分">+10分</span></p>
                </li>
                <li>
                    <img src="img/pinky.png" alt="天使">
                    <p>打擊天使鼠鼠<span data-stroke="扣10分">-10分</span></p>
                </li>
            </div>

            <div id="game-container">
                <!-- Holes will be generated by JavaScript -->
            </div>

            <div id="controls">
                <button id="start-button">開始遊戲</button>
                <button id="pause-button" disabled>暫停遊戲</button>
                <button id="restart-button" style="display: none;">重新開始</button>
            </div>

            <div id="end-game" class="body_mask">
                <div class="game_result">
                    <i class="foot"></i>
                    <h2>遊戲結束！</h2>
                    <p>你的分數是：<span id="final-score"></span></p>
                    <label for="username">輸入IG名稱上排行榜</label>
                    <input type="text" id="username" placeholder="IG帳號">
                    <p class="hint_text">取最高分 IG名稱記得打相同才會更新數據唷</p>

                    <button id="submit-score">提交</button>
                    <button id="close-button" class="close-button">關閉</button>
                </div>
            </div>
        </div>
    </div>
    <!-- boss警示訊息 -->
    <div id="boss-alert" class="alert hidden">
        <p>警告！隱藏Boss鼠鼠即將來襲！<br>擊中+50分</p>
    </div>

    <!-- Audio elements -->
    <audio id="background-music" src="music/background_music.wav" loop></audio>
    <audio id="devil-sound" src="music/click.mov" preload="auto"></audio>
    <audio id="angel-sound" src="music/angel_music.aiff" preload="auto"></audio>
    <audio id="boss-music" src="music/boss_music.mp3" preload="auto" loop></audio>
    <audio id="boss-sound" src="music/boss_sound.mp3" preload="auto"></audio>


    <!-- Firebase SDK -->
    <script type="module">
        document.addEventListener("DOMContentLoaded", function () {
            preloadAudio('music/boss_sound.mp3');
            preloadAudio('music/angel_music.aiff');
            preloadAudio('music/click.mp3');
            preloadAudio('music/background_music.wav'); // 背景音乐
        });

        // Firebase configuration and initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, query, orderByChild }
            from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

            const firebaseConfig = {
            apiKey: "AIzaSyB55n9AKgiOC2zQ-HW7sMx1HhScz6vxMI4",
            authDomain: "dev-shubalaxi.firebaseapp.com",
            projectId: "dev-shubalaxi",
            storageBucket: "dev-shubalaxi.firebasestorage.app",
            messagingSenderId: "829762203798",
            appId: "1:829762203798:web:f144c045ee00fed5e312b7",
            measurementId: "G-YYCBWMDGKL"
            };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.submitScoreToFirebase = async (username, score) => {
            const scoresRef = ref(db, `leaderboard/${username}`);
            try {
                // 嘗試先獲取現有數據
                const snapshot = await get(scoresRef);
                const currentData = snapshot.val();

                // 判斷是否需要更新分數
                if (currentData && currentData.score >= score) {
                    console.log(`New score (${score}) is not higher than the current score (${currentData.score})`);
                    alert("新分數未超過目前最高分，未更新！");
                    return;
                }

                // 更新分數（首次或新分數更高時）
                await set(scoresRef, {
                    name: username,
                    score: score,
                    timestamp: Date.now(),
                });

                console.log(`Score updated for ${username}`);
            } catch (error) {
                console.error("Error submitting score:", error);
                alert("提交分數時發生錯誤，請稍後再試");
            }
        };




        window.fetchLeaderboardData = (callback) => {
            const scoresRef = ref(db, 'leaderboard');
            onValue(scoresRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    callback([]);
                    return;
                }

                // 將物件轉為陣列並排序
                const scoresArray = Object.keys(data).map((key) => ({
                    name: key,
                    score: data[key].score,
                    timestamp: data[key].timestamp
                })).sort((a, b) => b.score - a.score); // 按分數降序排序

                callback(scoresArray);
            }, (error) => {
                console.error("Error fetching leaderboard:", error);
                callback([]);
            });
        };


    </script>

    <script>
        document.addEventListener('touchstart', function (event) {
            if (event.touches.length > 1) {
                event.preventDefault(); // 阻止缩放
            }
        }, { passive: false });
    </script>

    <script>
        // Game logic
        const GameState = {
            score: 0,
            timeLeft: 60,
            isPlaying: false,
            isPaused: false
        };

        // DOM Elements
        const elements = {
            timer: document.getElementById('timer'),
            score: document.getElementById('score'),
            startButton: document.getElementById('start-button'),
            pauseButton: document.getElementById('pause-button'),
            restartButton: document.getElementById('restart-button'),
            endGameDisplay: document.getElementById('end-game'),
            finalScore: document.getElementById('final-score'),
            gameContainer: document.getElementById('game-container'),
            leaderboard: document.getElementById('leaderboard'),
            leaderboardButton: document.getElementById('leaderboard-button'),
            closeLeaderboard: document.getElementById('close-leaderboard'),
            submitScoreButton: document.getElementById('submit-score'),
            closeButton: document.getElementById('close-button'),
            backgroundMusic: document.getElementById('background-music'),
            devilSound: document.getElementById('devil-sound'),
            angelSound: document.getElementById('angel-sound')
        };

        // Initialize game holes
        function initializeHoles() {
            elements.gameContainer.innerHTML = '';
            for (let i = 1; i <= 9; i++) {
                const hole = document.createElement('div');
                hole.className = 'hole';
                hole.dataset.index = i;
                elements.gameContainer.appendChild(hole);
            }
        }

        // Game functions
        function randomTime(min, max) {
            return Math.round(Math.random() * (max - min) + min);
        }

        function randomHole() {
            const holes = document.querySelectorAll('.hole');
            return holes[Math.floor(Math.random() * holes.length)];
        }

        // Audio API
        function playSoundWithWebAudio(audioUrl) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            fetch(audioUrl)
                .then(response => response.arrayBuffer())
                .then(data => audioContext.decodeAudioData(data))
                .then(buffer => {
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioContext.destination);
                    source.start(0);
                })
                .catch(error => console.error('Error with Web Audio API:', error));
        }

        function showHamster() {
            if (GameState.isPaused) return;

            const hole = randomHole();
            const hamsterType = Math.random() < 0.5 ? 'angel' : 'devil';
            const hamster = document.createElement('img');

            hamster.src = hamsterType === 'angel' ? 'img/pinky.png' : 'img/chuchi.png';
            hamster.classList.add('hamster', hamsterType);
            hamster.style.display = 'block';

            // 新增唯一標識符
            const uniqueId = Date.now() + Math.random();
            hamster.dataset.id = uniqueId;

            hole.appendChild(hamster);

            hamster.addEventListener('click', (event) => {
                // 防止同一隻鼠鼠重複點擊
                if (hamster.dataset.clicked) return;
                hamster.dataset.clicked = 'true';

                if (hamsterType === 'angel') {
                    GameState.score -= 10;
                    playSoundWithWebAudio('music/angel_music.aiff');
                } else {
                    GameState.score += 10;
                    playSoundWithWebAudio('music/click.mp3');
                }

                // 淡出效果，而不是立即移除
                hamster.style.opacity = '0.5';
                setTimeout(() => {
                    hamster.remove();
                }, 200);

                elements.score.textContent = GameState.score;
            });

            setTimeout(() => {
                hamster.style.transform = 'translateY(-70px)';
                setTimeout(() => {
                    // 如果鼠鼠沒被點擊，則移除
                    if (!hamster.dataset.clicked) {
                        hamster.remove();
                    }
                }, 1200);
            }, randomTime(1000, 2000));
        }

        // Game control functions
        function startGame() {
            GameState.score = 0;
            GameState.timeLeft = 60;
            GameState.isPlaying = true;
            GameState.isPaused = false;

            elements.backgroundMusic.volume = 0.5;
            elements.backgroundMusic.currentTime = 0;
            elements.backgroundMusic.play();

            elements.score.textContent = GameState.score;
            elements.timer.textContent = GameState.timeLeft;
            elements.endGameDisplay.style.display = 'none';
            elements.startButton.style.display = 'none';
            elements.pauseButton.style.display = 'block';
            elements.pauseButton.disabled = false;
            elements.restartButton.style.display = 'none';

            // 設置普通鼠鼠的出現計時器
            GameState.hamsterInterval = setInterval(showHamster, 600);

            // 隨機時間觸發 Boss 模式
            setTimeout(() => {
                if (GameState.isPlaying) startBossMode();
            }, randomTime(25000, 30000));

            // 設置遊戲計時器
            const timerInterval = setInterval(() => {
                if (!GameState.isPaused) {
                    GameState.timeLeft--;
                    elements.timer.textContent = GameState.timeLeft;
                    if (GameState.timeLeft <= 0) {
                        clearInterval(GameState.hamsterInterval);
                        clearInterval(timerInterval);
                        endGame();
                    }
                }
            }, 1000);
        }

        function pauseGame() {
            GameState.isPaused = !GameState.isPaused;
            elements.pauseButton.textContent = GameState.isPaused ? "繼續遊戲" : "暫停遊戲";

            if (GameState.isPaused) {
                elements.backgroundMusic.pause();
                document.querySelectorAll('.hamster').forEach(hamster => hamster.remove());
            } else {
                elements.backgroundMusic.play();
            }
        }

        function endGame() {
            GameState.isPlaying = false;
            elements.backgroundMusic.pause();
            elements.backgroundMusic.currentTime = 0;

            document.querySelectorAll('.hamster').forEach(hamster => hamster.remove());
            elements.finalScore.textContent = GameState.score;
            elements.endGameDisplay.style.display = 'block';
            elements.pauseButton.style.display = 'none';
            elements.restartButton.style.display = 'block';
        }

        // boss模式
        function startBossMode() {
            if (GameState.isPaused || !GameState.isPlaying) return;

            // 顯示警示訊息
            const bossAlert = document.getElementById('boss-alert');
            bossAlert.classList.remove('hidden');

            // 2 秒後隱藏警示訊息並啟動 Boss 模式
            setTimeout(() => {
                bossAlert.classList.add('hidden');

                // 切換到 Boss 音樂
                elements.backgroundMusic.pause();
                const bossMusic = document.getElementById('boss-music');
                bossMusic.currentTime = 0;
                bossMusic.play();

                // 停止普通鼠鼠的生成
                clearInterval(GameState.hamsterInterval);

                // 設置 Boss 鼠鼠快速生成和消失的邏輯
                const bossInterval = setInterval(() => {
                    const hole = randomHole();
                    const bossHamster = document.createElement('img');
                    bossHamster.src = 'img/boss2.png';
                    bossHamster.classList.add('hamster', 'boss');
                    bossHamster.style.display = 'block';

                    // 新增唯一標識符
                    const uniqueId = Date.now() + Math.random();
                    bossHamster.dataset.id = uniqueId;

                    bossHamster.addEventListener('click', (event) => {
                        // 防止同一隻鼠鼠重複點擊
                        if (bossHamster.dataset.clicked) return;
                        bossHamster.dataset.clicked = 'true';

                        GameState.score += 50;
                        elements.score.textContent = GameState.score;

                        // 淡出效果，而不是立即移除
                        bossHamster.style.opacity = '0.5';
                        setTimeout(() => {
                            bossHamster.remove();
                        }, 200);

                        playSoundWithWebAudio('music/boss_sound.mp3');
                    });

                    hole.appendChild(bossHamster);

                    // 調整移除邏輯
                    setTimeout(() => {
                        if (!bossHamster.dataset.clicked) {
                            bossHamster.remove();
                        }
                    }, 600);
                }, 200);

                // Boss 模式持續 15 秒
                setTimeout(() => {
                    clearInterval(bossInterval);
                    bossMusic.pause();
                    bossMusic.currentTime = 0;
                    elements.backgroundMusic.play(); // 恢復背景音樂

                    // 恢復普通鼠鼠的生成
                    GameState.hamsterInterval = setInterval(showHamster, 300);
                }, 15000);
            }, 2000);
        }

        // Event listeners
        elements.startButton.addEventListener('click', startGame);
        elements.pauseButton.addEventListener('click', pauseGame);
        elements.restartButton.addEventListener('click', startGame);
        elements.leaderboardButton.addEventListener('click', () => {
            const mask = document.getElementById('mask_bg'); // 獲取遮罩層
            elements.leaderboard.style.display =
                elements.leaderboard.style.display === 'none' ? 'block' : 'none';

            if (elements.leaderboard.style.display === 'block') {
                mask.style.display = 'block';
                fetchLeaderboardData((scores) => {
                    const leaderboardList = document.getElementById('leaderboard-list');
                    leaderboardList.innerHTML = '';  // 清空現有的排行榜

                    // 遍歷排行榜數據，最多顯示前5名
                    scores.slice(0, 10).forEach((entry, index) => {
                        const li = document.createElement('li');

                        // 創建排名 span
                        const rankSpan = document.createElement('span');
                        rankSpan.className = 'rank';
                        rankSpan.textContent = `${index + 1}`;

                        // 創建名稱 span
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'name';
                        nameSpan.textContent = entry.name;

                        // 創建分數 span
                        const scoreSpan = document.createElement('span');
                        scoreSpan.className = 'score';
                        scoreSpan.textContent = `${entry.score}`;

                        // 將所有的 span 元素添加到 li 裡
                        li.appendChild(rankSpan);
                        li.appendChild(nameSpan);
                        li.appendChild(scoreSpan);

                        // 將 li 添加到排行榜列表中
                        leaderboardList.appendChild(li);
                    });
                });
            }
        });


        elements.closeLeaderboard.addEventListener('click', () => {
            const mask = document.getElementById('mask_bg'); // 獲取遮罩層
            elements.leaderboard.style.display = 'none';
            mask.style.display = 'none';
        });

        elements.submitScoreButton.addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            if (username) {
                await submitScoreToFirebase(username, GameState.score);
                alert(`已提交分數！玩家：${username}，分數：${GameState.score}`);
                elements.endGameDisplay.style.display = 'none';
                elements.leaderboard.style.display = 'block';
                fetchLeaderboardData((scores) => {
                    const leaderboardList = document.getElementById('leaderboard-list');
                    leaderboardList.innerHTML = '';
                    scores.slice(0, 10).forEach((entry, index) => {
                        // 創建 li 元素
                        const li = document.createElement('li');

                        // 創建 span 包裹排名
                        const rankSpan = document.createElement('span');
                        rankSpan.className = 'rank'; // 可選的 class，用於樣式
                        rankSpan.textContent = `${index + 1} `;

                        // 創建 span 包裹名字
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'name'; // 可選的 class，用於樣式
                        nameSpan.textContent = entry.name;

                        // 創建 span 包裹分數
                        const scoreSpan = document.createElement('span');
                        scoreSpan.className = 'score'; // 可選的 class，用於樣式
                        scoreSpan.textContent = `${entry.score}`;

                        // 將 span 添加到 li
                        li.appendChild(rankSpan);
                        li.appendChild(nameSpan);
                        li.appendChild(scoreSpan);

                        // 添加到排行榜列表
                        leaderboardList.appendChild(li);
                    });
                });
            }
        });


        elements.closeButton.addEventListener('click', () => {
            elements.endGameDisplay.style.display = 'none';
        });

        // Set up cursor
        const defaultCursor = "url('img/hit.png') 16 16, auto";
        const clickedCursor = "url('img/hit2.png') 16 16, auto";

        document.body.style.cursor = defaultCursor;

        document.addEventListener('click', () => {
            document.body.style.cursor = clickedCursor;
            setTimeout(() => {
                document.body.style.cursor = defaultCursor;
            }, 100);
        });

        // Initialize game
        initializeHoles();
    </script>
    <script>
        let initialViewportHeight = window.innerHeight;

        window.addEventListener('resize', () => {
            const currentViewportHeight = window.innerHeight;

            if (currentViewportHeight < initialViewportHeight) {
                // 鍵盤彈出
                document.body.classList.add('keyboard-open');
            } else {
                // 鍵盤收起
                document.body.classList.remove('keyboard-open');
            }
        });

    </script>
</body>

</html>